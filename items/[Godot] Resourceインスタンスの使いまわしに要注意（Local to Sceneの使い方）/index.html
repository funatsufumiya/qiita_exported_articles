<h1>[Godot] Resourceインスタンスの使いまわしに要注意（Local to Sceneの使い方）</h1>
<h2 data-sourcepos="1:1-1:15">
<span id="まず結論" class="fragment"></span><a href="#%E3%81%BE%E3%81%9A%E7%B5%90%E8%AB%96"><i class="fa fa-link"></i></a>まず結論</h2>
<p data-sourcepos="3:1-3:152">Godotで使われるResourceは、Local to Sceneを適切に設定しないと、Materialなどのインスタンスは使い回されるので注意。</p>
<p data-sourcepos="5:1-5:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Fa6895633-92d8-1e80-7291-25060805d667.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1b55d7cad5682b1907379ad603fddfbf" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Fa6895633-92d8-1e80-7291-25060805d667.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1b55d7cad5682b1907379ad603fddfbf" alt="スクリーンショット 2024-10-14 21.41.56.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/a6895633-92d8-1e80-7291-25060805d667.png" loading="lazy"></a></p>
<h2 data-sourcepos="7:1-7:9">
<span id="概要" class="fragment"></span><a href="#%E6%A6%82%E8%A6%81"><i class="fa fa-link"></i></a>概要</h2>
<p data-sourcepos="9:1-9:215">Godotを使っていると自然に気づくことなのだけれど、Materialなど、各ノードのパラメータ等で指定する<code>Resource</code>は、何もしなければ別のノードでも使い回される。</p>
<p data-sourcepos="11:1-11:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F2aa9d980-9c37-4003-eff0-ed8283dedc0e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=493b87dbb5585adb3d91094fafeb79e2" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F2aa9d980-9c37-4003-eff0-ed8283dedc0e.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=493b87dbb5585adb3d91094fafeb79e2" alt="スクリーンショット 2024-10-14 21.47.15.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/2aa9d980-9c37-4003-eff0-ed8283dedc0e.png" loading="lazy"></a></p>
<p data-sourcepos="13:1-13:81">↑Resourceの見分け方は、「&gt; Resource」がついているのが特徴。</p>
<p data-sourcepos="15:1-15:263">例えば、ある作成済みのノードをコピーして、元のノードのマテリアルを編集すると、新しいノードでもその値が使われる。つまり、<strong>いわゆるシャローコピー (Shallow Copy) の状態</strong>になっている。</p>
<p data-sourcepos="17:1-17:78">これを避ける簡単な方法として、「ユニーク化」がある。</p>
<p data-sourcepos="19:1-19:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Fb7292419-8c93-3bbd-ea48-97a0d3d26f30.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6e37c2cfe6bbda7ff161a30fb22495a3" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Fb7292419-8c93-3bbd-ea48-97a0d3d26f30.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=6e37c2cfe6bbda7ff161a30fb22495a3" alt="スクリーンショット 2024-10-14 21.50.25.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/b7292419-8c93-3bbd-ea48-97a0d3d26f30.png" loading="lazy"></a></p>
<p data-sourcepos="21:1-21:162">ユニーク化すれば、別のリソースとなるので、別のノードで別のパラメータなどを指定しても、リンクすることはない。</p>
<p data-sourcepos="23:1-23:178">これで万事解決か？と思っていると、実は<strong>同じノードをPrefab的に、何度もリスポーンさせると、リソースの使い回しが発生する</strong>。</p>
<h2 data-sourcepos="25:1-25:21">
<span id="検証用コード" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC%E7%94%A8%E3%82%B3%E3%83%BC%E3%83%89"><i class="fa fa-link"></i></a>検証用コード</h2>
<p data-sourcepos="27:1-27:132">検証のために、以下のような簡単なプロジェクトを作ってみる。（執筆時点でGodot 4.3にて検証。）</p>
<p data-sourcepos="29:1-29:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F743dabcd-0625-7d0a-40aa-dcf1406e2d40.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c55b14a2cb060351b9c993b791ad265e" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F743dabcd-0625-7d0a-40aa-dcf1406e2d40.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=c55b14a2cb060351b9c993b791ad265e" alt="スクリーンショット 2024-10-14 21.40.41.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/743dabcd-0625-7d0a-40aa-dcf1406e2d40.png" loading="lazy"></a></p>
<p data-sourcepos="31:1-31:73">まずメインシーンとなる <code>test_scene.tscn</code> は以下の通り。</p>
<p data-sourcepos="33:1-33:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F686d8605-2e88-2faa-f181-0c6869024591.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=42ca5fdf9ed32e0219f2cfb00db42cce" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F686d8605-2e88-2faa-f181-0c6869024591.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=42ca5fdf9ed32e0219f2cfb00db42cce" alt="スクリーンショット 2024-10-14 21.40.10.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/686d8605-2e88-2faa-f181-0c6869024591.png" loading="lazy"></a></p>
<p data-sourcepos="35:1-35:82">ここで <code>TestSceneController</code> (<code>test_scene_controller.gd</code>) は以下の通り。</p>
<div class="code-frame" data-lang="gdscript" data-sourcepos="37:1-75:3"><div class="highlight"><pre><code><span class="k">class_name</span> <span class="n">TestSceneController</span>
<span class="k">extends</span> <span class="n">Node</span>

<span class="err">@</span><span class="k">export</span> <span class="k">var</span> <span class="n">vw</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">640</span>
<span class="err">@</span><span class="k">export</span> <span class="k">var</span> <span class="n">vh</span><span class="p">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">480</span>

<span class="err">@</span><span class="k">onready</span> <span class="k">var</span> <span class="n">scene_root</span><span class="p">:</span> <span class="n">Node2D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parent</span><span class="p">()</span>

<span class="k">var</span> <span class="n">is_first_time</span> <span class="o">=</span> <span class="bp">true</span>

<span class="c1"># Called when the node enters the scene tree for the first time.</span>
<span class="k">func</span> <span class="nf">_ready</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">:</span>
	<span class="k">pass</span> <span class="c1"># Replace with function body.</span>


<span class="c1"># Called every frame. 'delta' is the elapsed time since the previous frame.</span>
<span class="k">func</span> <span class="nf">_process</span><span class="p">(</span><span class="n">delta</span><span class="p">:</span> <span class="kt">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">:</span>
	<span class="k">pass</span>

<span class="k">func</span> <span class="nf">_spawn_obj</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">:</span>
	<span class="k">var</span> <span class="n">res</span><span class="p">:</span> <span class="n">Resource</span> <span class="o">=</span> <span class="nb">load</span><span class="p">(</span><span class="s2">"res://test_node.tscn"</span><span class="p">)</span>
	<span class="k">var</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Sprite2D</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">instantiate</span><span class="p">()</span>
	<span class="n">obj</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="kt">Vector2</span><span class="p">(</span><span class="n">randf_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vw</span><span class="p">),</span> <span class="n">randf_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vh</span><span class="p">))</span>

	<span class="k">if</span> <span class="n">is_first_time</span><span class="p">:</span>
		<span class="k">var</span> <span class="n">mat</span><span class="p">:</span> <span class="n">CanvasItemMaterial</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">material</span> <span class="k">as</span> <span class="n">CanvasItemMaterial</span>
		<span class="n">mat</span><span class="o">.</span><span class="n">blend_mode</span> <span class="o">=</span> <span class="n">CanvasItemMaterial</span><span class="o">.</span><span class="n">BLEND_MODE_ADD</span>
		<span class="n">is_first_time</span> <span class="o">=</span> <span class="bp">false</span>

	<span class="n">scene_root</span><span class="o">.</span><span class="n">add_child</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

<span class="k">func</span> <span class="nf">_unhandled_input</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">InputEvent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">void</span><span class="p">:</span>
	<span class="k">if</span> <span class="n">event</span> <span class="k">is</span> <span class="n">InputEventKey</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_pressed</span><span class="p">():</span>
			<span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">KEY_A</span><span class="p">:</span>
				<span class="n">_spawn_obj</span><span class="p">()</span>

</code></pre></div></div>
<p data-sourcepos="77:1-77:185">このコードは、<code>A</code>キーが押されるたびにランダムな位置に<code>TestNode</code>を作る。ただし、<strong>初回だけ</strong>マテリアルのブレンディングをADDにする。</p>
<p data-sourcepos="79:1-79:155">ちなみに<code>TestNode</code> (<code>test_node.gd</code>) は、以下のようなシンプルなSprite2Dで、<code>CanvasItemMaterial</code>がマテリアルに設定してある。</p>
<p data-sourcepos="81:1-81:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Fa79af976-0e67-0e11-673f-dbe4cc7f7d40.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3313382914beccdfab747f247aa4da5f" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Fa79af976-0e67-0e11-673f-dbe4cc7f7d40.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=3313382914beccdfab747f247aa4da5f" alt="スクリーンショット 2024-10-14 21.40.28.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/a79af976-0e67-0e11-673f-dbe4cc7f7d40.png" loading="lazy"></a></p>
<p data-sourcepos="83:1-83:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F82bcf61e-d929-6acb-9665-3555013acfa1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d8b9e840c13686527bce5f5790390dee" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F82bcf61e-d929-6acb-9665-3555013acfa1.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=d8b9e840c13686527bce5f5790390dee" alt="スクリーンショット 2024-10-14 21.40.24.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/82bcf61e-d929-6acb-9665-3555013acfa1.png" loading="lazy"></a></p>
<p data-sourcepos="85:1-85:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F4edcea53-b9ab-167f-5671-6e0ab06f24d5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1994f88c101e711bf96a0e90ba079f5a" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F4edcea53-b9ab-167f-5671-6e0ab06f24d5.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=1994f88c101e711bf96a0e90ba079f5a" alt="スクリーンショット 2024-10-14 22.01.13.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/4edcea53-b9ab-167f-5671-6e0ab06f24d5.png" loading="lazy"></a></p>
<h2 data-sourcepos="87:1-87:30">
<span id="検証用コードの実行" class="fragment"></span><a href="#%E6%A4%9C%E8%A8%BC%E7%94%A8%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E5%AE%9F%E8%A1%8C"><i class="fa fa-link"></i></a>検証用コードの実行</h2>
<p data-sourcepos="89:1-89:78">さて、このコードを素朴に実行すると、次のようになる。</p>
<p data-sourcepos="91:1-91:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F0095e813-036a-a014-8fde-44dd870ea833.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=799d0c67a1ccc2803b4a1f93c038ebab" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F0095e813-036a-a014-8fde-44dd870ea833.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=799d0c67a1ccc2803b4a1f93c038ebab" alt="スクリーンショット 2024-10-14 22.02.07.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/0095e813-036a-a014-8fde-44dd870ea833.png" loading="lazy"></a></p>
<p data-sourcepos="93:1-93:171">初回だけにブレンディングをADDに変更したにもかかわらず、リソースが使い回された結果、すべてに適用されてしまっている。</p>
<p data-sourcepos="95:1-95:196">しかも、これらのリソースはコピーされたわけではなく<strong>同じインスタンスを指している</strong>ので、一つの値を変えると残り全ても変わってしまう。</p>
<h3 data-sourcepos="97:1-97:30">
<span id="local-to-sceneの有効化" class="fragment"></span><a href="#local-to-scene%E3%81%AE%E6%9C%89%E5%8A%B9%E5%8C%96"><i class="fa fa-link"></i></a>Local to Sceneの有効化</h3>
<p data-sourcepos="99:1-99:80">では次に、Local to Sceneをオンにした上でもう一度実行する。</p>
<p data-sourcepos="101:1-101:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F7c47b16c-82af-6437-d8ff-743bd0172d7c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=515b23782b259fd32d85074811b9bebe" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F7c47b16c-82af-6437-d8ff-743bd0172d7c.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=515b23782b259fd32d85074811b9bebe" alt="スクリーンショット 2024-10-14 22.02.18.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/7c47b16c-82af-6437-d8ff-743bd0172d7c.png" loading="lazy"></a></p>
<p data-sourcepos="103:1-103:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Ffbd9d45a-37d6-748e-abef-3e8a26fc6155.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9a44166a6d13a59ebfed9219d6e5061b" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Ffbd9d45a-37d6-748e-abef-3e8a26fc6155.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=9a44166a6d13a59ebfed9219d6e5061b" alt="スクリーンショット 2024-10-14 22.02.40.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/fbd9d45a-37d6-748e-abef-3e8a26fc6155.png" loading="lazy"></a></p>
<p data-sourcepos="105:1-105:124">今度は、ちゃんと初回だけがADDになって、2回目以降は通常のブレンディングになっている。</p>
<p data-sourcepos="107:1-107:244">ちなみに Local to Scene が何を意味するかはドキュメントに書いてあり、今回の目的通り、各インスタンスが同じものを指すのではなくちゃんとコピーしたい場合に<code>true</code>にするとある。</p>
<p data-sourcepos="109:1-109:162"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Ffdce5601-8d28-e2f7-a82b-a13209417ff4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=556733820c73594b390dd1735b390e89" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2Ffdce5601-8d28-e2f7-a82b-a13209417ff4.png?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=556733820c73594b390dd1735b390e89" alt="スクリーンショット 2024-10-14 21.41.56.png""https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/fdce5601-8d28-e2f7-a82b-a13209417ff4.png" loading="lazy"></a></p>
<p data-sourcepos="111:1-111:238">（これを再帰的にやってくれるオプションがあれば、さらに子のリソースもディープコピー (Deep Copy) されて便利な気もするけど、そういうオプションってあるのだろうか…？）</p>
<h2 data-sourcepos="113:1-113:12">
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>
<p data-sourcepos="115:1-115:298">今回はマテリアルを例として取り上げたものの、すべての<code>Resource</code>について同じことがいえるので、例えば動画・音声プレイヤーなどで再生対象のファイルを動的に変えたりするようなシチュエーションでは、注意が必要。</p>
<p data-sourcepos="117:1-117:190">特に、ゲームの2回目の実行時は、一度使われたものを再度リスポーンすることが多いので、これにハマってしまうケースがあるので要注意。</p>
<p data-sourcepos="119:1-119:318">他の言語のシャローコピーやディープコピーと同じく、どちらが良いかはケースバイケースなので、例えば今回のようにコピーするのではなく、<code>ready()</code>のときに必要なパラメータをリセットするコードを呼ぶ、などとの使い分けが必要。</p>
