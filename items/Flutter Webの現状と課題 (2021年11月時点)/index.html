<p data-sourcepos="1:1-1:187">先日、実験的にFlutter Webを使い数ヶ月かけて開発を進め、最終的に、結局パフォーマンスの問題からReactにすべて書き換えたことがあった。</p>
<p data-sourcepos="3:1-3:181">同じ失敗をする人ができるだけ少ないように、現状のFlutter Webの課題点について、主に以下のIssueから引用して共有しておこうと思う。</p>
<p data-sourcepos="5:1-5:47"><iframe id="qiita-embed-content__428fe22293de6dfda5569ccebe4557c8" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__428fe22293de6dfda5569ccebe4557c8" data-content="https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F87182" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="7:1-7:361">前提として、Flutterはとても積極的に更新が行われているので、上記Issueで挙げられている問題点は徐々に解決すると思う。現状ではまだ関連IssueはOpenのままで、少なくともここ数ヶ月は変わりなく、執筆時点で最新版のFlutter 2.5.3ではまだ未解決な問題点を挙げていく。</p>
<h2 data-sourcepos="9:1-9:39">
<span id="初期読み込みが非常に重い" class="fragment"></span><a href="#%E5%88%9D%E6%9C%9F%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BF%E3%81%8C%E9%9D%9E%E5%B8%B8%E3%81%AB%E9%87%8D%E3%81%84"><i class="fa fa-link"></i></a>初期読み込みが非常に重い</h2>
<p data-sourcepos="11:1-11:47"><iframe id="qiita-embed-content__5eae0a42777e8795c542094677d4d11c" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__5eae0a42777e8795c542094677d4d11c" data-content="https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F46589" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="13:1-13:215">実際に <code>flutter build web --release</code>をしてアプリをデプロイしてみると分かるけれど、どんなに小さいアプリを作っても、<code>main.dart.js</code>のサイズがめちゃくちゃ大きい。</p>
<p data-sourcepos="15:1-15:233">マテリアルデザインだと、これにアイコンフォントの読み込みも入り、読み込んだあとの処理も加わるので、実用的なアプリだと初期読み込みに10秒くらいはザラでかかる。</p>
<p data-sourcepos="17:1-17:252">現状では、関連リソースをgzipで圧縮したり、軽いレンダラーのhtmlレンダラーを使うなどの方法もあるものの、htmlレンダラーには見た目上の問題点もあり、完全に解決することは難しい。</p>
<p data-sourcepos="19:1-19:177">たとえば初期化時に読込中表示を出すなどして対応する方法もあるけれど、将来的には根本的に解決してくれたらいいなぁと思う。</p>
<p data-sourcepos="21:1-21:58"><iframe id="qiita-embed-content__22469870543d71bfd44719d631c9feef" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__22469870543d71bfd44719d631c9feef" data-content="https%3A%2F%2Fqiita.com%2Ffunatsufumiya%2Fitems%2Fbd276485852372c01c3b" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<h2 data-sourcepos="23:1-23:72">
<span id="モバイル版ブラウザではパフォーマンス問題が多数" class="fragment"></span><a href="#%E3%83%A2%E3%83%90%E3%82%A4%E3%83%AB%E7%89%88%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%A7%E3%81%AF%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E5%95%8F%E9%A1%8C%E3%81%8C%E5%A4%9A%E6%95%B0"><i class="fa fa-link"></i></a>モバイル版ブラウザではパフォーマンス問題が多数</h2>
<p data-sourcepos="25:1-25:47"><iframe id="qiita-embed-content__ecb0d5e79d2f0579b389d139d0bf5eb3" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__ecb0d5e79d2f0579b389d139d0bf5eb3" data-content="https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F59332" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="27:1-27:47"><iframe id="qiita-embed-content__62a26eba10f6956d3e1ebd7867681fe5" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__62a26eba10f6956d3e1ebd7867681fe5" data-content="https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F56257" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="29:1-29:183">こちらは、バージョンが上がる度に少しずつ改善されているように思うけれど、執筆時点では未だに実用的なレベルにはなっていない。</p>
<p data-sourcepos="31:1-31:206">特にモバイルSafariやモバイルChromeでのパフォーマンスは深刻で、iOS/AndroidアプリではなくWeb版をモバイルで表示させるというのはあまり現実的ではない。</p>
<p data-sourcepos="33:1-33:293">ListViewを使ったり、スクロールしたり、アニメーションしたりと、基本的な操作がとても重くなるケースが未だに存在していて、かつブラウザごとに微妙にパフォーマンスに差異があるため、デバッグも簡単ではない。</p>
<h2 data-sourcepos="35:1-35:63">
<span id="テキストフィールドに文字がうまく打てない" class="fragment"></span><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB%E3%83%89%E3%81%AB%E6%96%87%E5%AD%97%E3%81%8C%E3%81%86%E3%81%BE%E3%81%8F%E6%89%93%E3%81%A6%E3%81%AA%E3%81%84"><i class="fa fa-link"></i></a>テキストフィールドに文字がうまく打てない</h2>
<p data-sourcepos="37:1-37:47"><iframe id="qiita-embed-content__79f85e8ab596f854e5801e150f00cfdd" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__79f85e8ab596f854e5801e150f00cfdd" data-content="https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F78550" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="39:1-39:264">これが個人的にはかなり厄介で、特に日本語入力は全然うまく打てない印象。記号を打つとフリーズしたり、入力途中の文字がダブって２つ入ってしまったりと、使っていてとてもイライラする。</p>
<p data-sourcepos="41:1-41:195">とはいえ、コピペして入力すれば一応打てるし、全く文字が打てないわけではないので、だましだまし使うことが一応できるのは不幸中の幸い。</p>
<p data-sourcepos="43:1-43:117">この現象はモバイル版に限らず通常のChromeでも発生し、特にCanvasKitレンダラーで深刻。</p>
<h2 data-sourcepos="45:1-45:65">
<span id="pcブラウザでもパフォーマンス問題は大きい" class="fragment"></span><a href="#pc%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%81%A7%E3%82%82%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E5%95%8F%E9%A1%8C%E3%81%AF%E5%A4%A7%E3%81%8D%E3%81%84"><i class="fa fa-link"></i></a>PCブラウザでも、パフォーマンス問題は大きい</h2>
<p data-sourcepos="47:1-47:205">前述のIssueでは、モバイル版ブラウザにおけるパフォーマンス問題が中心に取り上げられていたものの、PCブラウザでもパフォーマンスの問題は大きい。</p>
<p data-sourcepos="49:1-49:244">実際にWindows/Mac/Linux用のアプリとして書き出すとパフォーマンスの違いに驚いたりするし、特に複雑なUIや通信が発生してくるとパフォーマンス問題はどんどんと深刻になってくる。</p>
<p data-sourcepos="51:1-51:486">デバッグにおいても、iOS/Androidエミュレータでは使えるはずのFlutterのパフォーマンスビューがWebでは使えず、パフォーマンス改善やデバッグに相当苦戦を強いられる。Webでは通常使えるはずのDevToolも、CanvasKitレンダラーを基調にしているとうまく使えないし、Dartとjsのソースマップもうまくいかなかったりして、Flutter Webのパフォーマンス改善はとにかく辛い。</p>
<p data-sourcepos="53:1-53:458">個人的に特に困ったのが、最悪デスクトップアプリとして使えればいいやと思っていると、Web固有の機能がアプリ版では使えなかったり、iOS/Android/Web向けにpub.devから提供されているパッケージが、デスクトップアプリにはなかったりする。(特にWebカメラ周りや、iframe埋め込みのライブラリがWindows/Mac用は皆無なのが個人的に辛いところ…。)</p>
<h2 data-sourcepos="55:1-55:43">
<span id="一方でflutterで良かった点" class="fragment"></span><a href="#%E4%B8%80%E6%96%B9%E3%81%A7flutter%E3%81%A7%E8%89%AF%E3%81%8B%E3%81%A3%E3%81%9F%E7%82%B9"><i class="fa fa-link"></i></a>…一方で、Flutterで良かった点</h2>
<p data-sourcepos="57:1-57:243">…とこんな感じで多数のパフォーマンス問題があり、自分が抱えていたプロジェクトでは最終的にはReactに書き換えたわけだけれど、Flutterで書き始めたメリットもいくつかあった。</p>
<ul data-sourcepos="59:1-60:0">
<li data-sourcepos="59:1-60:0">マテリアルデザインを基調に組んでいたので、移植後もUIはほぼ変わらなかった</li>
</ul>
<p data-sourcepos="61:1-61:439">これはコーティング上も見た目上もメリットは大きく、最初にマテリアルデザインを基準にして開発を進めたのは良かった。HTML5でもマテリアルデザインはほぼそのまま使えるので、Reactに移植しようと決めたあともほぼ迷いなくそのまま移植でき、見た目のデザイン的にも、コードの全体像もほとんど変わりなく移植できた。</p>
<p data-sourcepos="63:1-63:275">初期開発のプロセスとしても、マテリアルデザインという"補助輪"のおかげでサクサクとシンプルにUIが作れたのは嬉しかった。もし最初から素のHTMLだったら、選択肢が多くてこうはいかなかったと思う。</p>
<ul data-sourcepos="65:1-66:0">
<li data-sourcepos="65:1-66:0">FlutterとReactは類似点が多いので、移行がスムーズ</li>
</ul>
<p data-sourcepos="67:1-67:146">これが個人的に嬉しかったポイントで、特にReact HooksとFlutterのRiverpodがよく似ていて、移植が簡単にできた。</p>
<p data-sourcepos="69:1-69:263">また、<code>Promise</code>と<code>Future</code>、<code>dynamic</code>と<code>any</code>、FlutterのNull-SafetyとTypeScriptのundefined/null check、Optional Chainingまわりなど、DartとTypeScriptの類似点が非常に多く、移植するのはそんなに難しいことではなかった。</p>
<p data-sourcepos="71:1-71:308">若干の演算子の違いがあったり、Flutterでは<code>List&lt;Widget&gt;</code>を返すところがReactでは<code>&lt;React.Fragment&gt;</code>で返せる点など、多少の違いはあるものの、両者は互いによく似ていて、ある程度抽象化していればほぼ同じコードが使えるのは嬉しい。</p>
<p data-sourcepos="73:1-73:270">ただ、名前付きパラメータの扱いや、JSX記法との違いなど、移植に悩む点はところどころあるものの、互換の記法はすぐ見つかるので、そこまで悩まずに済んだ。（この点は別の記事でまとめたい。）</p>
<p data-sourcepos="75:1-75:270">一方で、デバイス固有の処理を使っている場合は、やはり移植するには注意が必要。例えば永続化まわりなど、LocalStorageなどのブラウザ本来の機能で代替できる場合もあるし、そうでない場合もある。</p>
<ul data-sourcepos="77:1-78:0">
<li data-sourcepos="77:1-78:0">プラットフォーム間の差異がほとんどない</li>
</ul>
<p data-sourcepos="79:1-79:571">これはReactに書き換えて改めて実感したのだけれど、Flutterは独自のレンダラーを基盤にしているだけあって、プラットフォーム間の差異を自動で吸収してくれる。前述の問題点の大半はそれゆえに起こっているのだけれど、これはReact/React Nativeに対する大きなメリットで、Flutterからの移植後には、いろんなプラットフォームでUIが崩れていないか確認したりする作業が必要になってしまう。これはFlutterの今後に期待したい。</p>
<h2 data-sourcepos="81:1-81:12">
<span id="まとめ" class="fragment"></span><a href="#%E3%81%BE%E3%81%A8%E3%82%81"><i class="fa fa-link"></i></a>まとめ</h2>
<p data-sourcepos="83:1-83:236">ということで、Flutter自体は非常に楽しくて是非今後も使っていきたいフレームワークなのだけれど、Flutter Webを実践投入するのは、2.5.3の現時点でもまだ時期尚早という印象。</p>
<p data-sourcepos="85:1-85:318">本文中にも書いたように、デスクトップアプリ版ではまだ提供されていないパッケージも多い（特にWebカメラやiframe埋め込みなどデバイス・Webまわり）ので、最悪デスクトップアプリで書き出せばいいや、ともいかないので注意が必要。</p>
<p data-sourcepos="87:1-87:313">ただ、Flutter Webのおかげで<a href="https://dartpad.dev/" rel="nofollow noopener" target="_blank">DartPad</a>のようにすぐに書いたコードを共有できたり、エミュレータを使わなくても開発が進められたりとメリットもあるので、iOS/Android開発のオトモとしてFlutter Webを使うのはアリだと思う。</p>
<p data-sourcepos="89:1-89:291">もしFlutterで作り始めて、あとからWeb版が欲しくなっても、Reactとの類似点は非常に多くあるので、思い切って移植するのもそんなに苦ではないというのは一応安心。でもデバイス固有の機能を使っている場合は注意。</p>
