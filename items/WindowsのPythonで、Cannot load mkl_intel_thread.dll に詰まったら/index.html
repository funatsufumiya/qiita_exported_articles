<p data-sourcepos="1:1-1:280">何番煎じかわからないけれど、Windows上のPython (Anaconda/Miniconda) で <code>Intel MKL Fatal ERROR: Cannot load mkl_intel_thread.dll</code> で自分も詰まって、色々調査して解決したので、自分の思うベストソリューションをまとめてみる。</p>
<h2 data-sourcepos="3:1-3:69">
<span id="1-まずどのdllが読み込まれているかを確認する" class="fragment"></span><a href="#1-%E3%81%BE%E3%81%9A%E3%81%A9%E3%81%AEdll%E3%81%8C%E8%AA%AD%E3%81%BF%E8%BE%BC%E3%81%BE%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B%E3%82%92%E7%A2%BA%E8%AA%8D%E3%81%99%E3%82%8B"><i class="fa fa-link"></i></a>1. まず、どのdllが読み込まれているかを確認する</h2>
<p data-sourcepos="5:1-5:145">Anaconda PromptやPowershellなどで、<code>where.exe mkl_intel_thread.dll</code> を実行するとどのdllが読み込まれているかがわかる。</p>
<div class="code-frame" data-lang="powershell" data-sourcepos="7:1-13:3"><div class="highlight"><pre><code><span class="err">&gt;</span><span class="w"> </span><span class="n">where.exe</span><span class="w"> </span><span class="nx">mkl_intel_thread.dll</span><span class="w">

</span><span class="n">C:\Miniconda3\envs\mkl_test\Library\bin\mkl_intel_thread.dll</span><span class="w">

</span><span class="c"># メモ: Powershellで実行する場合は、where じゃなくて必ず where.exe !</span><span class="w">
</span></code></pre></div></div>
<p data-sourcepos="15:1-15:447">ここでAnacondaやMinicondaでインストールされている以外のdllが表示されているときは、間違いなく<strong>バージョンのミスマッチ</strong>でうまくいかないので、削除するか別のフォルダに移動する。（ちなみに手動でIntelのサイトから最新バージョンのMKLを入れている場合も、一旦Pathのフォルダから消したほうが良い。自分はここでハマッた。）</p>
<p data-sourcepos="17:1-17:176">なお、<code>conda activate xxx</code> を行うと <code>where.exe</code> の表示も変わるので、condaで独自環境を作っている場合は先にactivateしてから実行すべき。</p>
<h2 data-sourcepos="19:1-19:84">
<span id="2-dllを整理してもうまく行かなかったら新規に環境を作る" class="fragment"></span><a href="#2-dll%E3%82%92%E6%95%B4%E7%90%86%E3%81%97%E3%81%A6%E3%82%82%E3%81%86%E3%81%BE%E3%81%8F%E8%A1%8C%E3%81%8B%E3%81%AA%E3%81%8B%E3%81%A3%E3%81%9F%E3%82%89%E6%96%B0%E8%A6%8F%E3%81%AB%E7%92%B0%E5%A2%83%E3%82%92%E4%BD%9C%E3%82%8B"><i class="fa fa-link"></i></a>2. dllを整理してもうまく行かなかったら、新規に環境を作る</h2>
<p data-sourcepos="21:1-21:247">1.の手順で、余計なdllを削除して再度実行してもうまく行かない場合は、新規環境を作るのが良い。例えばPython3.6.5で環境を新規に作る場合は以下。<code>mkl_test</code>のところは好きな名前でOK。</p>
<div class="code-frame" data-lang="bash" data-sourcepos="23:1-29:3"><div class="highlight"><pre><code>conda create <span class="nt">-n</span> mkl_test <span class="nv">python</span><span class="o">=</span>3.6.5
conda activate mkl_test

<span class="c"># NOTE: Anaconda PromptではなくPowershellで最初にactivateを行うときは、</span>
<span class="c">#   `conda init powershell` してPowershellの再起動が必要。</span>
</code></pre></div></div>
<p data-sourcepos="31:1-31:332">ただしこの <code>create</code> のとき、いつものように最後にanacondaを入れると、デフォルトのnumpyとかscipyとかが入ってしまうので、入れるべきではない。<strong>あくまでMKLから先にインストールして、そこから自分の必要なライブラリをどんどん追加していく</strong>。</p>
<p data-sourcepos="33:1-33:125">MKLのバージョンについては、自分は2019.4ではうまく行かず、2019.1や2018.0.3ではうまくいった。</p>
<div class="code-frame" data-lang="bash" data-sourcepos="35:1-37:3"><div class="highlight"><pre><code>conda <span class="nb">install </span><span class="nv">mkl</span><span class="o">=</span>2019.1
</code></pre></div></div>
<p data-sourcepos="39:1-39:63">ここから、必要なライブラリを追加していく。</p>
<div class="code-frame" data-lang="bash" data-sourcepos="41:1-45:3"><div class="highlight"><pre><code>conda <span class="nb">install </span>numpy scipy
conda <span class="nb">install</span> <span class="nt">-c</span> pytorch <span class="nv">pytorch</span><span class="o">=</span>0.4.1
<span class="c"># などなど</span>
</code></pre></div></div>
<p data-sourcepos="47:1-47:167">そして最終的に <code>where.exe mkl_intel_thread.dll</code> でdllを確認して、今回作った環境のenvs以下のdllのみが表示されているのが正しい。</p>
<div class="code-frame" data-lang="text" data-sourcepos="49:1-53:3"><div class="highlight"><pre><code>&gt; where.exe mkl_intel_thread.dll

C:\Miniconda3\envs\mkl_test\Library\bin\mkl_intel_thread.dll
</code></pre></div></div>
<p data-sourcepos="55:1-55:94">この状態でもう一度 <code>import numpy</code> などを実行すれば、多分うまくいく。</p>
