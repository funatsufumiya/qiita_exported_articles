<h1>Flutter for Webの初期化時に読込中表示を出す方法</h1>
<p data-sourcepos="1:1-1:125"><a href="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F13d3c9a2-c7d0-0fc6-385a-86a93c65872b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a23944dd1a405fb0371fc06aefda2a95" target="_blank" rel="nofollow noopener"><img src="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F13d3c9a2-c7d0-0fc6-385a-86a93c65872b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;s=a23944dd1a405fb0371fc06aefda2a95" alt="Timeline-1.gif" srcset="https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.ap-northeast-1.amazonaws.com%2F0%2F44103%2F13d3c9a2-c7d0-0fc6-385a-86a93c65872b.gif?ixlib=rb-4.0.0&amp;auto=format&amp;gif-q=60&amp;q=75&amp;w=1400&amp;fit=max&amp;s=10ed0cd2c38304ef1e0bd4c27a6dd413 1x" data-canonical-src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/44103/13d3c9a2-c7d0-0fc6-385a-86a93c65872b.gif" loading="lazy"></a></p>
<p data-sourcepos="3:1-3:317">Flutter 2.5.1現在、Fluuter for Webのデバッグ時には上のgifのような読込中のインジケータ（ローディング画面）が表示されますが、現時点では<strong>デバッグ時のみ</strong>でリリースビルド時には表示されず、表示させるオプションは見当たりません。</p>
<p data-sourcepos="5:1-5:240">リリースビルド後、現時点で初期読み込み時間が10秒程度かかってしまうことはよくあることなので、<strong>リリース時にもデバッグ時と同じ読込中表示を出す方法</strong>をご紹介します。</p>
<p data-sourcepos="7:1-7:282">（根本的な問題である、<code>main.dart.js</code>のサイズが大きい問題や、マテリアルアイコンのフォントサイズが大きい問題には今回は触れません。(参考: <a href="https://github.com/flutter/flutter/issues/46589" rel="nofollow noopener" target="_blank">main.dart.js is too large #46589</a>) ）</p>
<h2 data-sourcepos="9:1-9:9">
<span id="方針" class="fragment"></span><a href="#%E6%96%B9%E9%87%9D"><i class="fa fa-link"></i></a>方針</h2>
<p data-sourcepos="11:1-11:292">読込中インジケータにはいろんな種類がありますが、今回は実際にデバッグ時に使われているものをそのまま表示させたいので、<code>packages/flutter_tools/lib/src/web/bootstrap.dart</code> に記載のコードを極力コピーして再利用します。</p>
<p data-sourcepos="13:1-13:96"><iframe id="qiita-embed-content__37a5c5eb8fb4ebb9a051c165fe622a19" src="https://qiita.com/embed-contents/link-card#qiita-embed-content__37a5c5eb8fb4ebb9a051c165fe622a19" data-content="https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fblob%2Fmaster%2Fpackages%2Fflutter_tools%2Flib%2Fsrc%2Fweb%2Fbootstrap.dart" frameborder="0" scrolling="no" loading="lazy" style="width:100%;" height="29">
</iframe>
</p>
<p data-sourcepos="15:1-15:343">実装としては、windowのloadイベントのタイミングでインジケータを消す方法がindex.htmlをいじるだけなので簡単ですが、それだと実際にFlutterのUIが表示されるまで案外ラグが大きいので、今回はFlutterのmain関数が呼ばれるタイミングで消えるようにしました。</p>
<h2 data-sourcepos="17:1-17:13">
<span id="indexhtml" class="fragment"></span><a href="#indexhtml"><i class="fa fa-link"></i></a>index.html</h2>
<p data-sourcepos="19:1-19:127">まず、<code>web/index.html</code>の<code>&lt;body&gt;</code>内に次を書き加えます。（styleとscriptは<code>&lt;head&gt;</code>内でも構いません。）</p>
<div class="code-frame" data-lang="html" data-sourcepos="21:1-81:3">
<div class="code-lang"><span class="bold">index.html</span></div>
<div class="highlight"><pre><code><span class="nt">&lt;style </span><span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
<span class="nc">.flutter-loader</span> <span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">8px</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#13B9FD</span><span class="p">;</span>
    <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
    <span class="nl">top</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
    <span class="nl">left</span><span class="p">:</span> <span class="m">0px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.indeterminate</span> <span class="p">{</span>
    <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.indeterminate</span><span class="nd">:before</span> <span class="p">{</span>
    <span class="nl">content</span><span class="p">:</span> <span class="s2">''</span><span class="p">;</span>
    <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#0175C2</span><span class="p">;</span>
    <span class="nl">animation</span><span class="p">:</span> <span class="n">indeterminate_first</span> <span class="m">2.0s</span> <span class="n">infinite</span> <span class="n">ease-out</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.indeterminate</span><span class="nd">:after</span> <span class="p">{</span>
    <span class="nl">content</span><span class="p">:</span> <span class="s2">''</span><span class="p">;</span>
    <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">background-color</span><span class="p">:</span> <span class="m">#02569B</span><span class="p">;</span>
    <span class="nl">animation</span><span class="p">:</span> <span class="n">indeterminate_second</span> <span class="m">2.0s</span> <span class="n">infinite</span> <span class="n">ease-in</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@keyframes</span> <span class="n">indeterminate_first</span> <span class="p">{</span>
    <span class="err">0</span><span class="o">%</span> <span class="p">{</span>
        <span class="nl">left</span><span class="p">:</span> <span class="m">-100%</span><span class="p">;</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="err">100</span><span class="o">%</span> <span class="p">{</span>
        <span class="nl">left</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">10%</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">@keyframes</span> <span class="n">indeterminate_second</span> <span class="p">{</span>
    <span class="err">0</span><span class="o">%</span> <span class="p">{</span>
        <span class="nl">left</span><span class="p">:</span> <span class="m">-150%</span><span class="p">;</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="err">100</span><span class="o">%</span> <span class="p">{</span>
        <span class="nl">left</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">10%</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;script&gt;</span>
<span class="kd">function</span> <span class="nf">flutterReady</span><span class="p">(){</span>
    <span class="c1">// console.log("flutter app is ready");</span>
    <span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementsByClassName</span><span class="p">(</span><span class="dl">'</span><span class="s1">loading</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">el</span><span class="p">){</span> <span class="nx">el</span><span class="p">.</span><span class="nf">remove</span><span class="p">();</span> <span class="p">}</span>
<span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"flutter-loader"</span><span class="nt">&gt;&lt;div</span> <span class="na">class=</span><span class="s">"indeterminate"</span><span class="nt">&gt;&lt;/div&gt;&lt;/div&gt;</span>
</code></pre></div>
</div>
<h2 data-sourcepos="83:1-83:12">
<span id="maindart" class="fragment"></span><a href="#maindart"><i class="fa fa-link"></i></a>main.dart</h2>
<p data-sourcepos="85:1-85:56">次に、<code>main.dart</code>に以下の記載を加えます。</p>
<div class="code-frame" data-lang="dart" data-sourcepos="87:1-101:3">
<div class="code-lang"><span class="bold">main.dart</span></div>
<div class="highlight"><pre><code><span class="kn">import</span> <span class="s">'package:flutter/foundation.dart'</span> <span class="kd">show</span> <span class="n">kIsWeb</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'package:js/js_util.dart'</span> <span class="k">as</span> <span class="n">js_util</span><span class="o">;</span>
<span class="kn">import</span> <span class="s">'dart:html'</span> <span class="k">as</span> <span class="n">html</span><span class="o">;</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">kIsWeb</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">js_util</span><span class="o">.</span><span class="na">hasProperty</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="na">window</span><span class="p">,</span> <span class="s">"flutterReady"</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">js_util</span><span class="o">.</span><span class="na">callMethod</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="na">window</span><span class="p">,</span> <span class="s">"flutterReady"</span><span class="p">,</span> <span class="p">[]);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// runApp(App()); などメインの処理</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p data-sourcepos="103:1-103:276">これで完成です。あとは実際にリリースビルドすれば、初回ロード時だけインジケータが表示されると思います。（もし<code>build</code>以下のindex.htmlが書き換わっていない場合は<code>web</code>以下からコピーすればOKです。）</p>
<p data-sourcepos="105:1-105:199">一度この雛形を組んでしまえば、index.htmlを好きにいじることで自分の好きなローディング画面を出すこともできるので、何かと便利だと思います。</p>
